<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="../classes.js" defer></script>
    <script src="../converter.js" defer></script>
    <link rel="stylesheet" type="text/css" href="../style.css">
</head>
<body>

<div id="content" style="padding: 10px; display: flex; flex-direction: column; height: 100%">
    <form>
        <select id="temperature-unit" name="temperature-unit">
            <optgroup label="Temperature Units">
                <option value="celsius">Celsius (°C)</option>
                <option value="fahrenheit">Fahrenheit (°F)</option>
                <option value="kelvin">Kelvin (K)</option>
            </optgroup>
        </select>
        <select id="wind-speed-unit" name="wind-speed-unit">
            <optgroup label="Wind Speed Units">
                <option value="meters-per-second">Meters per Second (m/s)</option>
                <option value="kilometers-per-hour">Kilometers per Hour (km/h)</option>
                <option value="miles-per-hour">Miles per Hour (mph)</option>
            </optgroup>
        </select>
        <input type="submit" value="Submit">
    </form>
    <!--    <h1>Current</h1>-->
    <!--    -->
    <!--    <h1>Forcast</h1>-->
</div>

</body>
</html>

<script type="module">
    const horsens = {
        name: "Horsens",
        latitude: 55.860916,
        longitude: 9.850000
    };
    createCurrentWeather();
    createForcastTable();


    var xhr = new XMLHttpRequest();
    var url = "https://api.open-meteo.com/v1/forecast" +
        "?latitude=" + horsens.latitude +
        "&longitude=" + horsens.longitude +
        "&hourly=temperature_2m" +
        "&current_weather=true" +
        "&precipitation_unit=inch" +
        "&timezone=Europe%2FBerlin" +
        "&start_date=2023-09-07" +
        "&end_date=2023-09-08";

    xhr.open("GET", url, true);

    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            console.log(response);
            createCurrentWeather(convertWeatherData(response, horsens.name));
            createForcastTable(convertForcastData(response, horsens.name));
        } else if (xhr.readyState === 4) {
            console.error("Request failed with status:", xhr.status);
        }
    };

    xhr.send()


    function createForcastTable(data) {
        if (document.getElementById("table") !== null) {
            document.getElementById("table").remove();
        }
        if (document.getElementById("forcast") !== null) {
            document.getElementById("forcast").remove();
        }

        let h1 = document.createElement("h1");
        h1.id = "forcast";
        h1.innerText = "Forcast";
        document.getElementById("content").appendChild(h1);

        let table = document.createElement("table");
        table.id = "table";
        let tr = document.createElement("tr");
        let th = document.createElement("th");
        let th2 = document.createElement("th");
        th.innerText = "Time";
        th2.innerText = "Temperature";
        tr.appendChild(th);
        tr.appendChild(th2);
        table.appendChild(tr);

        if (data === undefined) {
            return;
        }
        for (let i = 0; i < data.length; i++) {
            let tr = document.createElement("tr");
            let td = document.createElement("td");
            let td2 = document.createElement("td");
            td.innerText = data[i].getTime();
            td2.innerText = data[i].getMax() + " " + data[i].getUnit();
            tr.appendChild(td);
            tr.appendChild(td2);
            table.appendChild(tr);
        }
        document.getElementById("content").appendChild(table);
    }

    function createCurrentWeather(data) {
        const weatherContainer = document.createElement('div');
        weatherContainer.id = "weather-container";

        if (document.getElementById("current") !== null) {
            document.getElementById("current").remove();
        }

            let h2 = document.createElement("h1");
            h2.id = "current";
            h2.innerText = "Current weather";
            document.getElementById("content").appendChild(h2);

        if(data !== undefined) {
            let [time, date] = splitTimeDate(data[0].getTime());

            let p6 = document.createElement("p");
            p6.innerText = data[0].getPlace();
            weatherContainer.appendChild(p6);

            let p5 = document.createElement("p");
            p5.innerText = "Date: " + date;
            weatherContainer.appendChild(p5);

            let p4 = document.createElement("p");
            p4.innerText = "Time: " + time;
            weatherContainer.appendChild(p4);

            let p = document.createElement("p");
            p.innerText = "Temperature: " + data[0].getValue() + " " + data[0].getUnit();
            weatherContainer.appendChild(p);

            let p2 = document.createElement("p");
            p2.innerText = "Wind speed: " + data[1].getValue() + " " + data[1].getUnit();
            weatherContainer.appendChild(p2);

            let p3 = document.createElement("p");
            p3.innerText = "Wind direction: " + data[1].getDirection() + "°";
            weatherContainer.appendChild(p3);
        }

        document.getElementById("content").appendChild(weatherContainer);
    }

    function splitTimeDate(data){
        let time = data.split("T")[1];
        let date = data.split("T")[0];
        return [time, date];
    }

</script>